rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // --- Desarrollo: descomentar el bloque siguiente y comentar el resto para permitir todo a autenticados ---
    // match /{document=**} {
    //   allow read, write: if request.auth != null;
    // }

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && (
        (exists(/databases/$(database)/documents/coaches/$(request.auth.uid)) && get(/databases/$(database)/documents/coaches/$(request.auth.uid)).data.role == 'admin') ||
        (exists(/databases/$(database)/documents/players/$(request.auth.uid)) && get(/databases/$(database)/documents/players/$(request.auth.uid)).data.role == 'admin')
      );
    }

    // Tickets de soporte (crear/actualizar solo desde servidor)
    match /tickets/{ticketId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow create, update, delete: if false;
    }
    match /tickets/{ticketId}/messages/{messageId} {
      allow read: if isSignedIn() && (
        get(/databases/$(database)/documents/tickets/$(ticketId)).data.userId == request.auth.uid || isAdmin()
      );
      allow create, update, delete: if false;
    }

    // Usuarios (perfil propio)
    match /users/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    match /coaches/{coachId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == coachId;
    }

    match /players/{playerId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && (
        request.auth.uid == playerId ||
        resource.data.coachId == request.auth.uid
      );
    }

    match /clubs/{clubId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == clubId;
    }

    // Análisis de tiros (colección: analyses)
    match /analyses/{analysisId} {
      allow read: if isSignedIn() && (
        resource.data.playerId == request.auth.uid ||
        resource.data.coachId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        resource.data.playerId == request.auth.uid ||
        resource.data.coachId == request.auth.uid ||
        isAdmin()
      );
    }
    match /analyses/{analysisId}/keyframeAnnotations/{annotationId} {
      allow read, write: if isSignedIn();
    }
    match /analyses/{analysisId}/keyframeComments/{commentId} {
      allow read, write: if isSignedIn();
    }

    match /drills/{drillId} {
      allow read: if isSignedIn() && (
        resource.data.playerId == request.auth.uid ||
        resource.data.coachId == request.auth.uid
      );
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        resource.data.playerId == request.auth.uid ||
        resource.data.coachId == request.auth.uid
      );
    }

    match /playerProgress/{progressId} {
      allow read, write: if isSignedIn() && (
        resource.data.playerId == request.auth.uid ||
        resource.data.coachId == request.auth.uid
      );
    }

    // Wallets (solo dueño)
    match /wallets/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    // Config (ej. maintenance) – lectura admin o servidor; escritura solo servidor
    match /config/{docId} {
      allow read: if isSignedIn();
      allow write: if false;
    }

    // Solicitudes de coach (crear cualquiera autenticado; leer solo admin desde API)
    match /coach_applications/{appId} {
      allow create: if isSignedIn();
      allow read, update, delete: if false;
    }

    // Cola de revisión IA (solo servidor / admin vía API)
    match /ia_review_queue/{docId} {
      allow read, write: if false;
    }

    // Pagos (crear/actualizar desde servidor; usuario lee los suyos vía API)
    match /payments/{paymentId} {
      allow read, write: if false;
    }

    // Mensajes (coach–player) – escritura solo servidor
    match /messages/{messageId} {
      allow read, write: if false;
    }

    // Denegar todo lo no definido
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
